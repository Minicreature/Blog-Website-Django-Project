{% extends "blog/base.html" %}
{% block content %}
<article class="post-detail" style="max-width: 800px; margin: 0 auto;">
  <div class="card" style="border: none; box-shadow: none; background: transparent;">
    <div class="card-meta">
      <img class="author-img" src="{{ object.author.profile.avatar_url }}" alt="{{ object.author.username }}">
      <a href="{% url 'user-posts' object.author.username %}" class="link-subtle">{{ object.author.username }}</a>
      <span>&bull;</span>
      <span>{{ object.date_posted|date:"F d, Y" }}</span>
      {% if object.category %}
      <span class="category-tag">{{ object.category.name }}</span>
      {% endif %}
    </div>

    <h1 class="article-title" style="font-size: 2.5rem; margin-bottom: 1.5rem;">{{ object.title }}</h1>

    <div class="article-content" style="font-size: 1.125rem; line-height: 1.8; margin-bottom: 2rem;">
      {{ object.content|linebreaks }}
    </div>

    {% if object.author == user %}
    <div class="post-actions" style="margin-bottom: 2rem;">
      <a class="btn btn-outline" href="{% url 'post-update' object.id %}">Update</a>
      <a class="btn btn-outline" style="color: #ef4444; border-color: #ef4444;"
        href="{% url 'post-delete' object.id %}">Delete</a>
    </div>
    {% endif %}
  </div>

  <!-- Comments Section -->
  <div class="comments-section" style="margin-top: 4rem; border-top: 1px solid var(--border); padding-top: 2rem;">
    <h3>Comments ({{ object.comments.count }})</h3>

    {% if user.is_authenticated %}
    <form method="POST" style="margin-bottom: 2rem;">
      {% csrf_token %}
      <div class="form-group">
        {{ form.content }}
      </div>
      <button class="btn btn-primary" type="submit">Post Comment</button>
    </form>
    {% else %}
    <p><a href="{% url 'login' %}">Log in</a> to leave a comment.</p>
    {% endif %}

    <div class="comments-list">
      {% for comment in object.comments.all %}
      <div class="comment" id="comment-{{ comment.id }}"
        style="margin-bottom: 1.5rem; padding: 1rem; background: var(--surface); border-radius: var(--radius-md); border: 1px solid var(--border);">
        <div class="comment-meta"
          style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">
          <div>
            <strong>{{ comment.author.username }}</strong>
            <span>&bull; {{ comment.date_posted|timesince }} ago</span>
          </div>
          {% if user == comment.author %}
          <div class="comment-actions">
            <button onclick="toggleEdit('{{ comment.id }}')" class="btn-link"
              style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.875rem; margin-right: 0.5rem;">Edit</button>
            <button onclick="deleteComment('{{ comment.id }}')" class="btn-link"
              style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.875rem;">Delete</button>
          </div>
          {% endif %}
        </div>
        <p id="comment-content-{{ comment.id }}">{{ comment.content }}</p>

        {% if user == comment.author %}
        <div id="edit-form-{{ comment.id }}" style="display: none; margin-top: 1rem;">
          <textarea id="edit-textarea-{{ comment.id }}" class="form-control" rows="3"
            style="margin-bottom: 0.5rem;">{{ comment.content }}</textarea>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="saveComment('{{ comment.id }}')" class="btn btn-primary"
              style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Save</button>
            <button onclick="toggleEdit('{{ comment.id }}')" class="btn btn-outline"
              style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Cancel</button>
          </div>
        </div>
        {% endif %}
      </div>
      {% empty %}
      <p>No comments yet.</p>
      {% endfor %}
    </div>

    <script>
      function toggleEdit(commentId) {
        const content = document.getElementById(`comment-content-${commentId}`);
        const form = document.getElementById(`edit-form-${commentId}`);
        if (form.style.display === 'none') {
          form.style.display = 'block';
          content.style.display = 'none';
        } else {
          form.style.display = 'none';
          content.style.display = 'block';
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function saveComment(commentId) {
        const textarea = document.getElementById(`edit-textarea-${commentId}`);
        const content = textarea.value;
        const csrftoken = getCookie('csrftoken');

        fetch(`/comment/update/${commentId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ content: content })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById(`comment-content-${commentId}`).innerText = data.content;
              toggleEdit(commentId);
            } else {
              alert(data.error || 'Error updating comment');
            }
          });
      }

      function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;

        const csrftoken = getCookie('csrftoken');

        fetch(`/comment/delete/${commentId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById(`comment-${commentId}`).remove();
            } else {
              alert(data.error || 'Error deleting comment');
            }
          });
      }
    </script>
  </div>
</article>
{% endblock content %}